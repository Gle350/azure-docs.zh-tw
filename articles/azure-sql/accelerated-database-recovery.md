---
title: 加速資料庫復原
titleSuffix: Azure SQL
description: 加速資料庫復原可針對 Azure SQL 組合中的資料庫，提供快速且一致的資料庫復原、瞬間的交易回復，以及積極的記錄截斷。
ms.service: sql-database
ms.subservice: high-availability
ms.custom: sqldbrb=4
ms.devlang: ''
ms.topic: conceptual
author: stevestein
ms.author: sstein
ms.reviewer: ''
ms.date: 05/19/2020
ms.openlocfilehash: bd1b33b2f6b1b0e0bf94639b3991b6507a89f5a9
ms.sourcegitcommit: cc13f3fc9b8d309986409276b48ffb77953f4458
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/14/2020
ms.locfileid: "97400789"
---
# <a name="accelerated-database-recovery-in-azure-sql"></a>Azure SQL 中的加速資料庫復原 
[!INCLUDE[appliesto-sqldb-sqlmi](includes/appliesto-sqldb-sqlmi.md)]

**加速資料庫復原 (ADR)** 是 SQL Server database engine 功能，可透過重新設計 SQL Server 資料庫引擎復原程式，大幅改善資料庫可用性（特別是在有長時間執行的交易時）。 

ADR 目前適用于 Azure SQL Database、Azure SQL 受控執行個體、Azure Synapse Analytics 中的資料庫，以及從 SQL Server 2019 開始的 Azure Vm 上的 SQL Server。 

> [!NOTE] 
> 在 Azure SQL Database 和 Azure SQL 受控執行個體中預設會啟用 ADR，且不支援任何產品的 ADR。 

## <a name="overview"></a>概觀

ADR 的主要優點為：

- **快速且一致的資料庫復原**

  使用 ADR，長時間執行的交易便不會影響整體復原時間，可快速且一致地進行資料庫復原，不論系統內使用中的交易數或其大小為何。

- **瞬間交易回復**

  使用 ADR，交易回復會在瞬間完成，不論交易處於使用中狀態的時間長度，或是已執行的更新數為何。

- **積極性記錄截斷**

  使用 ADR，交易記錄會積極地進行截斷，即使有使用中的長時間執行交易，它也能防止其失去控制。

## <a name="standard-database-recovery-process"></a>標準資料庫復原處理序

資料庫復原會遵循 [>aries](https://people.eecs.berkeley.edu/~brewer/cs262/Aries.pdf) 復原模式並包含三個階段，如下圖所示，並會在圖表後面詳細說明。

![目前的復原處理序](./media/accelerated-database-recovery/current-recovery-process.png)

- **分析階段**

  從最後一個成功檢查點的開頭開始向前掃描交易記錄 (或最舊的中途分頁 LSN) 直到結束為止，以判斷資料庫停止時每個交易的狀態。

- **重做階段**

  從最舊的未認可交易直到結束的交易記錄順向掃描，可藉由重做所有獲認可的作業，來將資料庫帶到其在發生毀損時所處的狀態。

- **復原階段**

  對於每個在發生毀損時處於作用中的交易，向後周遊記錄，以復原此交易所執行的作業。

根據這項設計，SQL Server 資料庫引擎從非預期的重新開機進行復原所需的時間，) 大約是 (與當機時系統中最長的使用中交易大小成正比。 復原需要回復所有未完成的交易。 所需時間與交易執行的工作和其已使用時間成比例。 因此，復原程式可能會花很長的時間來顯示長時間執行的交易 (例如大型的大量插入作業或針對大型資料表) 的索引建立作業。

同時，根據此設計來取消/回復大型交易也會花費很長的時間，因為它使用如前所述的相同復原階段。

此外，當有長時間執行的交易時，SQL Server database engine 無法截斷交易記錄，因為復原和復原進程需要它們的對應記錄檔記錄。 由於這項 SQL Server 資料庫引擎的設計，有些客戶用來面對問題，那就是交易記錄檔的大小變得很大，而且會耗用大量的磁片磁碟機空間。

## <a name="the-accelerated-database-recovery-process"></a>加速資料庫復原程序

ADR 藉由完全重新設計 SQL Server 資料庫引擎復原程式來解決上述問題：

- 透過避免從最舊使用中交易的開頭進行掃描，或是掃描至開頭，來固定時間或使其能夠立即完成。 使用 ADR，只會從最後一次成功的檢查點 (或是最舊的中途分頁記錄序號 (LSN)) 開始處理交易記錄。 因此，復原時間不會受到長時間執行的交易影響。
- 將所需的交易記錄空間減至最小，因為不再需要處理整個交易的記錄。 因此，可在進行檢查點和備份時積極地截斷交易記錄。

從高層級而言，ADR 會透過對所有實體資料庫修改建立版本，並只復原邏輯作業 (其數量有限且可以立即進行復原) 來快速地進行資料庫復原。 任何在發生毀損時處於作用中的交易都會標記為已中止，因此，並行使用者查詢會忽略這些交易所產生的任何版本。

ADR 復原處理序與目前復原處理序具有相同的三個階段。 下圖說明這三個階段使用 ADR 運作的方式，並且會在下圖後面進行更詳細的說明。

![ADR 復原處理序](./media/accelerated-database-recovery/adr-recovery-process.png)

- **分析階段**

  處理序與以往的處理序相同，但會加上重新建構 sLog 並複製未建立版本作業的記錄檔記錄。
  
- **重做** 階段

  分成兩個階段 (P)
  - 階段 1

      從 sLog 重做 (最舊的未認可交易至最後一個檢查點)。 重做是快速的作業，因為它只需要處理來自 sLog 的幾個記錄。

  - 階段 2

     從交易記錄進行重做，會從最後一個檢查點 (而不是最舊的未認可交易) 開始

- **復原階段**

   使用 ADR 的復原階段可透過下列方式以幾乎瞬間的方式來完成：使用 sLog 來復原非版本控制的作業及具備邏輯還原的持續版本存放區 (PV)，來執行以版本為基礎的資料列層級復原。

## <a name="adr-recovery-components"></a>ADR 復原元件

ADR 的四個關鍵元件為：

- **持續版本存放區 (PVS)**

  持續版本存放區是新的 SQL Server 資料庫引擎機制，用來保存資料庫本身所產生的資料列版本，而不是傳統 `tempdb` 版本存放區。 PVS 會啟用資源隔離，以及改善可讀取之次要複本的可用性。

- **邏輯還原**

  邏輯還原是非同步的處理序，負責執行資料列層級版本式復原，為所有建立版本的作業提供交易立即回復和復原。 邏輯還原的完成方式：

  - 追蹤所有已中止的交易，並將這些交易標示為其他交易不可見。 
  - 對所有使用者交易使用 PVS 來執行復原，而不是實際掃描交易記錄並一次復原一項變更。
  - 在交易中止後立即釋出所有鎖定。 由於中止牽涉到直接標記記憶體中的變更，這個流程非常有效率，而且不需要長時間保留鎖定。

- **sLog**

  sLog 是一種次要的記憶體內部記錄串流，其儲存未建立版本作業的記錄檔記錄 (例如中繼資料快取無效判定、取得鎖定等)。 sLog 是：

  - 體積小並位於記憶體內部
  - 透過在檢查點處理序期間進行序列化來保存在磁碟上
  - 在交易認可時定期截斷
  - 透過只處理未建立版本的作業來加速重做和復原  
  - 透過只保留需要的記錄檔記錄來啟用積極性交易記錄截斷

- **清除工具**

  清除工具是一種非同步處理序，會定期喚醒並清理不需要的分頁版本。

## <a name="accelerated-database-recovery-patterns"></a>加速資料庫復原模式

ADR 對於下列類型的工作負載產生的效益最大：

- 具有長時間執行交易的工作負載。
- 曾經歷使用中交易造成交易記錄大幅成長的工作負載。  
- 由於長時間執行的復原 (（例如非預期的服務重新開機或手動交易回復) ），而經歷很長一段時間的資料庫無法使用的工作負載。
